# 量化系统开发文档

## 项目概述

基于pandaquant代码库构建的完整量化投资平台，实现因子挖掘、策略回测、模拟交易和交易信号推送等功能，主要服务于中国A股市场。

## 技术架构

### 整体架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    量化投资平台                              │
├─────────────────────────────────────────────────────────────┤
│  Web界面层 (React + Chakra UI)                             │
│  ├── 策略管理界面                                           │
│  ├── 回测结果展示                                           │
│  ├── 实时监控面板                                           │
│  └── 用户权限管理 (复用现有)                               │
├─────────────────────────────────────────────────────────────┤
│  API层 (FastAPI) - 基于现有架构扩展                        │
│  ├── 用户认证与权限 (完全复用)                             │
│  ├── 策略管理API (新增)                                    │
│  ├── 数据管理API (新增)                                    │
│  └── 任务调度API (新增)                                    │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层 - 新增量化模块                                  │
│  ├── 数据层 (Tushare + 多数据源)                           │
│  ├── 因子层 (Qlib + TA-Lib + pandas_ta)                   │
│  ├── 策略层 (Backtrader + vnpy)                           │
│  ├── 信号层 (多渠道推送)                                   │
│  └── 调度层 (APScheduler + Celery)                        │
├─────────────────────────────────────────────────────────────┤
│  数据存储层 - 扩展现有架构                                  │
│  ├── PostgreSQL (结构化数据，完全复用)                     │
│  ├── InfluxDB (时序数据，新增)                             │
│  └── Redis (缓存和队列，新增)                              │
└─────────────────────────────────────────────────────────────┘
```

## 已完成的功能模块

### 1. 数据源抽象层架构 ✅

#### 文件位置

- `backend/app/domains/data/sources/base.py` - 数据源抽象基类
- `backend/app/domains/data/sources/tushare.py` - Tushare数据源实现
- `backend/app/domains/data/sources/factory.py` - 数据源工厂模式

#### 核心功能

- **抽象基类 (DataSource)**：

  - 支持优先级管理 (priority)
  - 健康检查机制 (health_check)
  - 错误计数和自动禁用 (error_count, max_errors)
  - 状态管理 (ACTIVE, INACTIVE, ERROR)

- **Tushare数据源实现**：

  - 支持多种数据类型：daily, minute, macro, financial, industry, concept
  - 参数验证机制
  - 错误处理和重试机制
  - 健康检查实现

- **数据源工厂模式**：
  - 多数据源管理
  - 自动故障转移
  - 优先级排序
  - 统一接口调用

#### 技术特点

- 遵循依赖倒置原则
- 支持多数据源扩展
- 自动故障转移机制
- 健康检查和状态监控

### 2. 数据服务层 ✅

#### 文件位置

- `backend/app/domains/data/services.py` - 数据服务主类

#### 核心功能

- **多数据源支持**：使用数据源工厂模式
- **统一时序数据存储**：InfluxDB存储所有时序数据
- **关系数据存储**：PostgreSQL存储用户、策略、信号等关系数据
- **通用数据存储**：支持行情、宏观、财务、行业等不同类型数据
- **灵活数据查询**：支持按测量类型、标签、字段查询
- **数据标准化**：统一在数据源层面处理

#### 技术特点

- 抽象层依赖，不直接依赖具体数据源
- 支持数据源故障转移
- 数据格式标准化统一在数据源层面处理
- 简化的DataService类，职责更清晰
- 统一使用InfluxDB存储时序数据，简化架构
- 多数据源架构验证（Tushare + akshare）
- 完整的测试覆盖（单元测试 + 集成测试）

### 3. 因子服务层 ✅

#### 文件位置

- `backend/app/domains/factors/services.py` - 因子服务类

#### 核心功能

- **技术指标计算**：基于technical.indicators库

  - 移动平均线 (SMA, EMA)
  - 相对强弱指数 (RSI)
  - MACD指标
  - 布林带 (Bollinger Bands)
  - ATR, 随机指标, 威廉指标等

- **自定义因子**：支持配置化因子计算

  - 价格比率因子
  - 成交量比率因子
  - 动量因子
  - 波动率因子
  - 自定义公式因子

- **因子存储**：PostgreSQL存储因子数据
- **因子查询**：支持按时间范围查询因子数据

#### 技术特点

- 模块化因子计算
- 支持自定义因子扩展
- 数据持久化存储

### 4. 策略服务层 ✅

#### 文件位置

- `backend/app/domains/strategies/services.py` - 策略服务类

#### 核心功能

- **策略管理**：

  - 创建、查询、更新、删除策略
  - 支持多种策略类型 (factor_mining, backtest)
  - 策略配置管理

- **回测引擎**：基于Backtrader

  - 支持多策略类型
  - 性能指标计算 (收益率、夏普比率、最大回撤等)
  - 交易分析

- **回测结果存储**：PostgreSQL存储回测结果

#### 技术特点

- 基于Backtrader的成熟回测框架
- 支持策略配置化
- 完整的性能分析

### 5. 信号服务层 ✅

#### 文件位置

- `backend/app/domains/signals/services.py` - 信号服务类

#### 核心功能

- **信号生成**：基于技术指标分析

  - RSI信号分析
  - MACD信号分析
  - 移动平均线信号分析
  - 多指标综合信号

- **多渠道推送**：

  - 企业微信推送
  - 邮件推送
  - 钉钉推送

- **信号管理**：
  - 信号状态跟踪
  - 信号历史查询
  - 推送结果记录

#### 技术特点

- 多指标综合信号生成
- 多渠道推送支持
- 信号状态管理

### 6. 数据模型层 ✅

#### 文件位置

- `backend/app/models.py` - 数据模型定义

#### 核心模型

- **Strategy**：策略模型
- **Backtest**：回测结果模型
- **Factor**：因子模型
- **Signal**：交易信号模型
- **MarketData**：市场数据模型

#### 技术特点

- 基于SQLModel的ORM
- 支持关系映射
- 索引优化

## 待完成的功能模块

### 1. 数据源扩展 🔄

#### 计划添加

- **akshare数据源**：免费开源数据源
- **yfinance数据源**：国际数据源
- **Wind数据源**：专业金融数据源

#### 实现步骤

1. 创建akshare数据源实现
2. 创建yfinance数据源实现
3. 集成到数据源工厂
4. 测试多数据源切换

### 2. 因子抽象层增强 🔄

#### 计划功能

- **因子抽象基类**：支持自定义因子类型
- **因子注册机制**：动态注册因子
- **因子验证**：因子有效性验证
- **因子组合**：多因子组合计算

#### 实现步骤

1. 创建因子抽象基类
2. 实现因子注册机制
3. 添加因子验证功能
4. 支持因子组合计算

### 3. 策略模板系统 🔄

#### 计划功能

- **策略模板库**：常见量化策略模板
- **策略代码生成**：从模板生成策略代码
- **策略参数化**：支持策略参数配置
- **策略版本管理**：策略版本控制

#### 实现步骤

1. 设计策略模板结构
2. 实现模板引擎
3. 创建常用策略模板
4. 集成到策略服务

### 4. API路由层 🔄

#### 计划功能

- **数据管理API**：数据获取、同步API
- **因子管理API**：因子计算、查询API
- **策略管理API**：策略CRUD、回测API
- **信号管理API**：信号生成、推送API

#### 实现步骤

1. 创建数据管理API路由
2. 创建因子管理API路由
3. 创建策略管理API路由
4. 创建信号管理API路由

### 5. 前端界面 🔄

#### 计划功能

- **策略管理界面**：策略创建、编辑、管理
- **回测分析界面**：回测结果展示、分析
- **因子管理界面**：因子计算、查询、管理
- **信号监控界面**：实时信号监控、历史查询

#### 实现步骤

1. 设计前端界面架构
2. 实现策略管理界面
3. 实现回测分析界面
4. 实现因子管理界面
5. 实现信号监控界面

## 技术选型说明

### 数据源选型

- **Tushare**：主数据源，专门为A股设计
- **akshare**：备用数据源，免费开源
- **yfinance**：国际数据源，用于对比分析

### 因子计算选型

- **technical.indicators**：技术指标库
- **pandas_ta**：现代技术指标库
- **TA-Lib**：经典技术指标库

### 回测引擎选型

- **Backtrader**：成熟稳定的回测框架
- **vnpy**：A股专业适配

### 信号推送选型

- **企业微信**：主要推送渠道
- **邮件**：重要信号备份
- **钉钉**：备用推送渠道

## 开发进度

### 已完成 ✅

1. 数据源抽象层架构设计
2. Tushare数据源实现
3. 数据源工厂模式
4. 数据服务层重构
5. 因子服务层实现
6. 策略服务层实现
7. 信号服务层实现
8. 数据模型层设计
9. 数据标准化架构重构（数据源层面统一处理）
10. DataService类完整重构（统一InfluxDB存储，支持通用数据存储和查询）
11. akshare数据源实现和集成
12. 数据层完整测试套件

### 进行中 🔄

1. 准备开始因子抽象层增强

### 待开始 📋

1. 因子抽象层增强
2. 策略模板系统
3. API路由层实现
4. 前端界面开发

## 下一步开发计划

### 短期目标（1-2周）

1. 完成DataService类重构
2. 实现akshare数据源
3. 创建基础API路由
4. 测试多数据源切换

### 中期目标（3-4周）

1. 实现因子抽象层增强
2. 创建策略模板系统
3. 完善API路由层
4. 开始前端界面开发

### 长期目标（1-2个月）

1. 完成前端界面开发
2. 系统集成测试
3. 性能优化
4. 文档完善

## 技术债务和改进点

### 当前技术债务

1. DataService类需要完全重构以使用数据源工厂
2. 因子服务层缺乏抽象层设计
3. 策略服务层的Backtrader集成需要完善
4. 信号服务层的推送渠道需要测试

### 改进方向

1. 增强系统的可扩展性
2. 提高代码的模块化程度
3. 完善错误处理机制
4. 优化性能表现

## 部署和运维

### 环境要求

- Python 3.11+
- PostgreSQL 17+
- InfluxDB 2.7+
- Redis 7+
- Docker & Docker Compose

### 配置要求

- Tushare Token
- InfluxDB配置
- Redis配置
- 微信企业号配置
- 邮件服务配置

## 总结

当前量化系统已经完成了核心架构设计和主要功能模块的实现。系统采用了模块化设计，支持多数据源、多因子类型、多策略类型，具有良好的可扩展性。

下一步的重点是完善数据源工厂模式的使用，添加更多数据源支持，并开始API层和前端界面的开发。整个系统预计在1-2个月内可以完成基础功能，为量化投资业务提供强有力的技术支撑。
