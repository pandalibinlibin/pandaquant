# 量化系统开发文档

## 项目概述

基于pandaquant代码库构建的完整量化投资平台，实现因子挖掘、策略回测、模拟交易和交易信号推送等功能，主要服务于中国A股市场。

## 技术架构

### 整体架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    量化投资平台                              │
├─────────────────────────────────────────────────────────────┤
│  Web界面层 (React + Chakra UI)                             │
│  ├── 策略管理界面                                           │
│  ├── 回测结果展示                                           │
│  ├── 实时监控面板                                           │
│  └── 用户权限管理 (复用现有)                               │
├─────────────────────────────────────────────────────────────┤
│  API层 (FastAPI) - 基于现有架构扩展                        │
│  ├── 用户认证与权限 (完全复用)                             │
│  ├── 策略管理API (新增)                                    │
│  ├── 数据管理API (新增)                                    │
│  └── 任务调度API (新增)                                    │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层 - 新增量化模块                                  │
│  ├── 数据层 (Tushare + 多数据源)                           │
│  ├── 因子层 (Qlib + TA-Lib + pandas_ta)                   │
│  ├── 策略层 (Backtrader + vnpy)                           │
│  ├── 信号层 (多渠道推送)                                   │
│  └── 调度层 (APScheduler + Celery)                        │
├─────────────────────────────────────────────────────────────┤
│  数据存储层 - 扩展现有架构                                  │
│  ├── PostgreSQL (结构化数据，完全复用)                     │
│  ├── InfluxDB (时序数据，新增)                             │
│  └── Redis (缓存和队列，新增)                              │
└─────────────────────────────────────────────────────────────┘
```

## 已完成的功能模块

### 1. 数据源抽象层架构 ✅

#### 文件位置

- `backend/app/domains/data/sources/base.py` - 数据源抽象基类
- `backend/app/domains/data/sources/tushare.py` - Tushare数据源实现
- `backend/app/domains/data/sources/factory.py` - 数据源工厂模式

#### 核心功能

- **抽象基类 (DataSource)**：

  - 支持优先级管理 (priority)
  - 健康检查机制 (health_check)
  - 错误计数和自动禁用 (error_count, max_errors)
  - 状态管理 (ACTIVE, INACTIVE, ERROR)

- **Tushare数据源实现**：

  - 支持多种数据类型：daily, minute, macro, financial, industry, concept
  - 参数验证机制
  - 错误处理和重试机制
  - 健康检查实现

- **数据源工厂模式**：
  - 多数据源管理
  - 自动故障转移
  - 优先级排序
  - 统一接口调用

#### 技术特点

- 遵循依赖倒置原则
- 支持多数据源扩展
- 自动故障转移机制
- 健康检查和状态监控

### 2. 数据服务层 ✅

#### 文件位置

- `backend/app/domains/data/services.py` - 数据服务主类

#### 核心功能

- **多数据源支持**：使用数据源工厂模式
- **统一时序数据存储**：InfluxDB存储所有时序数据
- **关系数据存储**：PostgreSQL存储用户、策略、信号等关系数据
- **通用数据存储**：支持行情、宏观、财务、行业等不同类型数据
- **灵活数据查询**：支持按测量类型、标签、字段查询
- **数据标准化**：统一在数据源层面处理
- **标准字段定义**：覆盖所有数据类型的最大集字段定义
- **严格数据验证**：确保所有标准字段都存在
- **缺失字段处理**：使用特殊值标识人为填入的字段

#### 技术特点

- 抽象层依赖，不直接依赖具体数据源
- 支持数据源故障转移
- 数据格式标准化统一在数据源层面处理
- 简化的DataService类，职责更清晰
- 统一使用InfluxDB存储时序数据，简化架构
- 多数据源架构验证（Tushare + akshare）
- 完整的测试覆盖（单元测试 + 集成测试）
- 全面数据标准化架构（标准字段定义、严格验证、缺失字段处理）
- 支持所有数据类型的统一字段格式
- 缺失字段使用特殊值标识（-999999.0, None）

### 3. 因子服务层 ✅

#### 文件位置

- `backend/app/domains/factors/base.py` - 因子抽象基类
- `backend/app/domains/factors/technical.py` - 技术指标因子实现
- `backend/app/domains/factors/fundamental.py` - 基本面因子实现
- `backend/app/domains/factors/report.py` - 报告因子实现
- `backend/app/domains/factors/services.py` - 因子服务类
- `backend/tests/domains/factors/test_technical_factors.py` - 技术因子测试（12个测试用例）
- `backend/tests/domains/factors/test_fundamental_factors.py` - 基本面因子测试（4个测试用例）
- `backend/tests/domains/factors/test_report_factors.py` - 报告因子测试（4个测试用例）
- `backend/tests/domains/factors/test_factor_service.py` - 因子服务测试（5个测试用例）

#### 核心功能

- **因子抽象基类**：统一的因子接口设计

  - 支持因子类型分类 (TECHNICAL, FUNDAMENTAL, CUSTOM)
  - 因子状态管理 (ACTIVE, INACTIVE, ERROR)
  - 错误计数和自动禁用机制
  - Qlib表达式和依赖管理
  - 金融工程报告因子追踪

- **技术指标因子**：基于TA-Lib实现

  - 移动平均线 (SMA, EMA) ✅ - 4个测试用例
  - 相对强弱指数 (RSI) ✅ - 2个测试用例
  - MACD指标 ✅ - 2个测试用例
  - 布林带 (Bollinger Bands) ✅ - 2个测试用例
  - KDJ随机指标 ✅ - 2个测试用例
  - 更多技术指标 (计划中)

- **基本面因子**：财务数据相关因子

  - 财务比率因子 (PE, PB, ROE, ROA) ✅ - 4个测试用例
  - 更多基本面因子 (计划中)

- **报告因子**：金融工程报告因子

  - 动量因子 ✅ - 4个测试用例
  - 更多报告因子 (计划中)

- **因子服务层**：因子注册和管理

  - 因子注册表 (FactorRegistry) ✅
  - 因子服务类 (FactorService) ✅
  - 因子计算和批量计算 ✅
  - 因子状态管理 ✅
  - 默认因子自动注册 ✅
  - 全局因子服务实例 ✅

- **自定义因子**：支持配置化因子计算
- **Qlib集成**：专业因子挖掘和研究
- **报告因子**：金融工程报告因子实现

  - 价格比率因子
  - 成交量比率因子
  - 动量因子
  - 波动率因子
  - 自定义公式因子

- **因子存储**：PostgreSQL存储因子数据
- **因子查询**：支持按时间范围查询因子数据

#### 技术特点

- **统一抽象接口**：所有因子继承自Factor基类，提供一致的接口
- **Qlib集成支持**：支持Qlib表达式和依赖管理，便于策略开发
- **技术指标库**：基于TA-Lib实现标准技术指标，确保计算准确性
- **参数化配置**：支持因子参数自定义，适应不同策略需求
- **状态管理**：完整的错误处理和成功记录，便于监控和调试
- **研究报告支持**：为金融工程报告提供因子实现，支持学术研究
- 模块化因子计算
- 支持自定义因子扩展
- 数据持久化存储
- 因子状态管理和错误处理

### 4. 策略服务层 ✅

#### 文件位置

- `backend/app/domains/strategies/base_strategy.py` - 策略抽象基类
- `backend/app/domains/strategies/technical_strategy.py` - 双均线策略实现
- `backend/app/domains/strategies/services.py` - 策略服务类
- `backend/app/domains/strategies/factory.py` - 策略工厂类

#### 核心功能

- **策略抽象基类 (BaseStrategy)**：

  - 继承自Backtrader.Strategy
  - 支持配置驱动的策略参数
  - 集成因子服务，支持因子计算
  - 提供历史数据获取接口
  - 抽象方法：next(), \_generate_signal(), \_execute_trade()

- **策略注册中心**：

  - 动态策略类注册和管理
  - 策略类型检查（必须继承BaseStrategy）
  - 策略信息查询和状态管理
  - 支持策略类的注册、注销、查询

- **策略工厂 (StrategyFactory)**：

  - 自动发现策略类（扫描\*\_strategy.py文件）
  - 自动注册发现的策略类
  - 策略类信息查询
  - 支持策略类的动态加载

- **双均线策略实现 (DualMovingAverageStrategy)**：

  - 基于短期和长期移动平均线交叉
  - 支持配置化参数（均线周期、仓位大小）
  - 异步因子计算支持
  - 完整的信号生成和交易执行逻辑
  - 丰富的信号信息（动作、目标价格、信号强度）

- **策略管理**：

  - 创建、查询、更新、删除策略
  - 支持多种策略类型
  - 策略配置管理
  - 策略名称唯一性约束

- **回测引擎**：基于Backtrader

  - 支持多策略类型
  - 性能指标计算 (收益率、夏普比率、最大回撤等)
  - 交易分析
  - 完整的回测参数配置（佣金、滑点、保证金、杠杆等）

- **回测结果存储**：PostgreSQL存储回测结果

#### 技术特点

- **模块化设计**：策略基类、具体策略、服务层分离
- **配置驱动**：策略参数通过配置传递，支持灵活定制
- **异步支持**：支持异步因子计算，提高性能
- **自动发现**：策略工厂自动发现和注册策略类
- **类型安全**：严格的类型检查和验证
- **错误处理**：完善的错误处理和状态管理
- **基于Backtrader**：成熟稳定的回测框架
- **支持策略配置化**：完整的性能分析

### 5. 信号服务层 ✅

#### 文件位置

- `backend/app/domains/signals/services.py` - 信号服务类

#### 核心功能

- **信号生成**：基于技术指标分析

  - RSI信号分析
  - MACD信号分析
  - 移动平均线信号分析
  - 多指标综合信号

- **多渠道推送**：

  - 企业微信推送
  - 邮件推送
  - 钉钉推送

- **信号管理**：
  - 信号状态跟踪
  - 信号历史查询
  - 推送结果记录

#### 技术特点

- 多指标综合信号生成
- 多渠道推送支持
- 信号状态管理

### 6. 数据模型层 ✅

#### 文件位置

- `backend/app/models.py` - 数据模型定义

#### 核心模型

- **Strategy**：策略模型
- **Backtest**：回测结果模型
- **Factor**：因子模型
- **Signal**：交易信号模型
- **MarketData**：市场数据模型

#### 技术特点

- 基于SQLModel的ORM
- 支持关系映射
- 索引优化

## 待完成的功能模块

### 1. 数据源扩展 🔄

#### 计划添加

- **akshare数据源**：免费开源数据源
- **yfinance数据源**：国际数据源
- **Wind数据源**：专业金融数据源

#### 实现步骤

1. 创建akshare数据源实现
2. 创建yfinance数据源实现
3. 集成到数据源工厂
4. 测试多数据源切换

### 2. 因子抽象层增强 🔄

#### 计划功能

- **因子抽象基类**：支持自定义因子类型
- **因子注册机制**：动态注册因子
- **因子验证**：因子有效性验证
- **因子组合**：多因子组合计算

#### 实现步骤

1. 创建因子抽象基类
2. 实现因子注册机制
3. 添加因子验证功能
4. 支持因子组合计算

### 3. 策略模板系统 🔄

#### 计划功能

- **策略模板库**：常见量化策略模板
- **策略代码生成**：从模板生成策略代码
- **策略参数化**：支持策略参数配置
- **策略版本管理**：策略版本控制

#### 实现步骤

1. 设计策略模板结构
2. 实现模板引擎
3. 创建常用策略模板
4. 集成到策略服务

### 4. API路由层 🔄

#### 计划功能

- **数据管理API**：数据获取、同步API
- **因子管理API**：因子计算、查询API
- **策略管理API**：策略CRUD、回测API
- **信号管理API**：信号生成、推送API

#### 实现步骤

1. 创建数据管理API路由
2. 创建因子管理API路由
3. 创建策略管理API路由
4. 创建信号管理API路由

### 5. 前端界面 🔄

#### 计划功能

- **策略管理界面**：策略创建、编辑、管理
- **回测分析界面**：回测结果展示、分析
- **因子管理界面**：因子计算、查询、管理
- **信号监控界面**：实时信号监控、历史查询

#### 实现步骤

1. 设计前端界面架构
2. 实现策略管理界面
3. 实现回测分析界面
4. 实现因子管理界面
5. 实现信号监控界面

## 技术选型说明

### 数据源选型

- **Tushare**：主数据源，专门为A股设计
- **akshare**：备用数据源，免费开源
- **yfinance**：国际数据源，用于对比分析

### 因子计算选型

- **technical.indicators**：技术指标库
- **pandas_ta**：现代技术指标库
- **TA-Lib**：经典技术指标库

### 回测引擎选型

- **Backtrader**：成熟稳定的回测框架
- **vnpy**：A股专业适配

### 信号推送选型

- **企业微信**：主要推送渠道
- **邮件**：重要信号备份
- **钉钉**：备用推送渠道

## 开发进度

### 已完成 ✅

1. 数据源抽象层架构设计
2. Tushare数据源实现
3. 数据源工厂模式
4. 数据服务层重构
5. 因子服务层实现
6. 策略服务层实现
7. 信号服务层实现
8. 数据模型层设计
9. 数据标准化架构重构（数据源层面统一处理）
10. DataService类完整重构（统一InfluxDB存储，支持通用数据存储和查询）
11. akshare数据源实现和集成
12. 数据层完整测试套件
13. 全面数据标准化架构（标准字段定义、严格验证、缺失字段处理）
14. 因子抽象层架构设计（支持技术指标、Qlib集成、金融工程报告因子）
15. 技术指标因子实现（移动平均线、RSI、MACD、布林带、KDJ）
16. 基本面因子实现（财务比率因子）
17. 报告因子实现（动量因子）
18. 因子服务层完整实现（因子注册、计算、状态管理）
19. 因子服务层测试套件（5个测试用例全部通过）
20. 策略抽象基类设计（BaseStrategy）
21. 策略注册中心实现（动态策略类管理）
22. 策略工厂实现（自动发现和注册策略类）
23. 双均线策略实现（DualMovingAverageStrategy）
24. 策略服务层完整实现（策略CRUD、回测引擎、结果存储）
25. 异步因子计算支持
26. 策略配置驱动架构
27. 策略名称唯一性约束

### 进行中 🔄

1. 暂无进行中的任务

### 待开始 📋

1. 策略模板系统
2. API路由层实现
3. 前端界面开发

## 下一步开发计划

### 短期目标（1-2周）

1. 策略模板系统开发
   - 设计策略模板结构
   - 实现模板引擎
   - 创建常用策略模板
2. API路由层实现
   - 数据管理API
   - 因子管理API
   - 策略管理API
   - 信号管理API

### 中期目标（3-4周）

1. 完善Qlib集成支持
2. 开始前端界面开发
3. 系统集成测试
4. 性能优化

### 长期目标（1-2个月）

1. 完成前端界面开发
2. 系统集成测试
3. 性能优化
4. 文档完善

## 技术债务和改进点

### 当前技术债务

1. 信号服务层的推送渠道需要测试
2. API路由层需要实现
3. 前端界面需要开发
4. 系统集成测试需要完善

### 改进方向

1. 增强系统的可扩展性
2. 提高代码的模块化程度
3. 完善错误处理机制
4. 优化性能表现
5. 完善API接口设计
6. 增强前端用户体验

## 部署和运维

### 环境要求

- Python 3.11+
- PostgreSQL 17+
- InfluxDB 2.7+
- Redis 7+
- Docker & Docker Compose

### 配置要求

- Tushare Token
- InfluxDB配置
- Redis配置
- 微信企业号配置
- 邮件服务配置

## 总结

当前量化系统已经完成了核心架构设计和主要功能模块的实现。系统采用了模块化设计，支持多数据源、多因子类型、多策略类型，具有良好的可扩展性。

**核心成就**：

- ✅ **完整的数据层**：多数据源支持、数据标准化、InfluxDB存储
- ✅ **完整的因子层**：技术指标、基本面、报告因子，支持Qlib集成
- ✅ **完整的策略层**：策略抽象基类、策略工厂、双均线策略实现
- ✅ **异步支持**：因子计算和策略执行支持异步操作
- ✅ **配置驱动**：所有模块都支持配置化参数
- ✅ **自动发现**：策略工厂自动发现和注册策略类
- ✅ **类型安全**：严格的类型检查和验证机制

**技术亮点**：

- 模块化架构设计，职责分离清晰
- 支持多数据源故障转移
- 因子计算支持异步操作
- 策略注册中心支持动态管理
- 完整的错误处理和状态管理
- 基于成熟框架（Backtrader、InfluxDB、PostgreSQL）

下一步的重点是API路由层和前端界面的开发，以及系统集成测试。整个系统预计在1-2个月内可以完成基础功能，为量化投资业务提供强有力的技术支撑。
